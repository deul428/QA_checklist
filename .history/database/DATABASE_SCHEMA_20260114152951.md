# QA 체크리스트 시스템 데이터베이스 스키마

## 개요

QA 체크리스트 시스템은 SQLite 데이터베이스를 사용하며, 사용자 관리, 시스템 관리, 체크리스트 항목 관리, 체크리스트 기록 관리를 위한 6개의 주요 테이블로 구성되어 있습니다.

**데이터베이스 파일 위치**: `database/qa_checklist.db`

---

## 테이블 구조

### 1. users (사용자 테이블)

시스템 사용자 정보를 저장하는 테이블입니다.

| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| `id` | INTEGER | PRIMARY KEY, AUTO INCREMENT | 사용자 고유 ID (대리키) |
| `employee_id` | VARCHAR(50) | UNIQUE, NOT NULL, INDEX | 사번 (자연키, 로그인에 사용) |
| `name` | VARCHAR(100) | NOT NULL | 사용자 이름 |
| `email` | VARCHAR(255) | NOT NULL | 이메일 주소 (알림 발송용) |
| `password_hash` | VARCHAR(255) | NOT NULL | 비밀번호 해시 (bcrypt) |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | 계정 생성 시간 |
| `updated_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP, ON UPDATE | 계정 정보 수정 시간 |

**특징:**
- `employee_id`는 고유하며 로그인에 사용됩니다
- 비밀번호는 bcrypt로 해시되어 저장됩니다
- 이메일은 스케줄러에서 미체크 항목 알림 발송에 사용됩니다

**관계:**
- `user_system_assignments` 테이블과 1:N 관계
- `checklist_records` 테이블과 1:N 관계

---

### 2. systems (시스템 테이블)

체크리스트를 관리할 시스템 정보를 저장하는 테이블입니다.

| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| `id` | INTEGER | PRIMARY KEY, AUTO INCREMENT | 시스템 고유 ID |
| `system_name` | VARCHAR(100) | NOT NULL | 시스템 이름 (예: "EAI", "IAS Sales") |
| `description` | TEXT | NULL | 시스템 설명 |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | 시스템 등록 시간 |

**특징:**
- 각 시스템은 여러 체크 항목을 가질 수 있습니다
- 시스템 이름은 중복될 수 있지만, 일반적으로 고유한 이름을 사용합니다

**관계:**
- `check_items` 테이블과 1:N 관계 (CASCADE DELETE)
- `user_system_assignments` 테이블과 1:N 관계 (CASCADE DELETE)

---

### 3. check_items (체크 항목 테이블)

각 시스템에 대한 체크리스트 항목을 저장하는 테이블입니다.

| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| `id` | INTEGER | PRIMARY KEY, AUTO INCREMENT | 체크 항목 고유 ID |
| `system_id` | INTEGER | FOREIGN KEY, NOT NULL | 소속 시스템 ID (systems.id 참조) |
| `item_name` | VARCHAR(200) | NOT NULL | 체크 항목 이름 |
| `description` | TEXT | NULL | 체크 항목 상세 설명 및 확인 사항 (특이사항 포함) |
| `order_index` | INTEGER | DEFAULT 0 | 표시 순서 (정렬용) |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | 항목 생성 시간 |

**특징:**
- 각 항목은 반드시 하나의 시스템에 속합니다
- 시스템이 삭제되면 해당 시스템의 모든 체크 항목도 자동 삭제됩니다 (CASCADE DELETE)
- `order_index`를 사용하여 항목 표시 순서를 제어할 수 있습니다
- `description` 필드에는 체크 항목의 상세 설명과 함께 확인해야 하는 사항(특이사항)이 포함됩니다

**관계:**
- `systems` 테이블과 N:1 관계
- `checklist_records` 테이블과 1:N 관계 (CASCADE DELETE)

---

### 4. user_system_assignments (사용자-시스템 담당 관계 테이블)

어떤 사용자가 어떤 시스템을 담당하는지 나타내는 관계 테이블입니다.

| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| `id` | INTEGER | PRIMARY KEY, AUTO INCREMENT | 관계 고유 ID |
| `user_id` | INTEGER | FOREIGN KEY, NOT NULL | 사용자 ID (users.id 참조) |
| `system_id` | INTEGER | FOREIGN KEY, NOT NULL | 시스템 ID (systems.id 참조) |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | 할당 시간 |

**특징:**
- 한 사용자는 여러 시스템을 담당할 수 있습니다
- 한 시스템은 여러 사용자가 담당할 수 있습니다 (다대다 관계)
- 사용자나 시스템이 삭제되면 해당 할당도 자동 삭제됩니다 (CASCADE DELETE)
- 이 테이블을 통해 사용자가 대시보드에서 볼 수 있는 시스템 목록이 결정됩니다

**관계:**
- `users` 테이블과 N:1 관계
- `systems` 테이블과 N:1 관계

---

### 5. checklist_records (체크리스트 기록 테이블)

사용자가 체크 항목을 체크한 기록을 저장하는 테이블입니다.

| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| `id` | INTEGER | PRIMARY KEY, AUTO INCREMENT | 기록 고유 ID |
| `user_id` | INTEGER | FOREIGN KEY, NOT NULL | 체크한 사용자 ID (users.id 참조) |
| `check_item_id` | INTEGER | FOREIGN KEY, NOT NULL | 체크한 항목 ID (check_items.id 참조) |
| `check_date` | DATE | NOT NULL | 체크한 날짜 |
| `status` | VARCHAR(10) | NOT NULL, CHECK | 체크 상태 ('PASS' 또는 'FAIL') |
| `notes` | TEXT | NULL | 체크 시 입력한 메모/특이사항 |
| `checked_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | 체크한 시간 |

**특징:**
- `status`는 반드시 'PASS' 또는 'FAIL' 중 하나여야 합니다 (CHECK 제약조건)
- 같은 사용자가 같은 항목을 같은 날짜에 여러 번 체크할 수 없습니다 (애플리케이션 레벨에서 제어)
- 사용자나 체크 항목이 삭제되면 해당 기록도 자동 삭제됩니다 (CASCADE DELETE)
- 스케줄러는 이 테이블을 조회하여 매일 미체크 항목을 확인하고 알림을 발송합니다

**관계:**
- `users` 테이블과 N:1 관계
- `check_items` 테이블과 N:1 관계

**비즈니스 로직:**
- 매일 각 사용자는 자신이 담당하는 시스템의 모든 체크 항목을 체크해야 합니다
- 오늘 날짜(`check_date`)에 체크되지 않은 항목이 있으면 스케줄러가 알림을 발송합니다

---

## 테이블 관계도 (ERD)

```
users (1) ──< (N) user_system_assignments (N) >── (1) systems
  │                                                      │
  │                                                      │
  │ (1)                                                  │ (1)
  │                                                      │
  └──< (N) checklist_records                            │
         │                                                │
         │ (N)                                            │ (1)
         │                                                │
         └──> (1) check_items
```

**관계 설명:**
- **users ↔ systems**: 다대다 관계 (user_system_assignments를 통한 중간 테이블)
- **users → checklist_records**: 1대다 관계 (한 사용자는 여러 기록을 가짐)
- **systems → check_items**: 1대다 관계 (한 시스템은 여러 체크 항목을 가짐)
- **check_items → checklist_records**: 1대다 관계 (한 항목은 여러 기록을 가짐)

---

## 인덱스

성능 최적화를 위한 인덱스:

1. **users.employee_id**: UNIQUE INDEX
   - 로그인 시 사번으로 빠른 조회를 위해 사용

2. **checklist_records.check_date**: INDEX
   - 날짜별 조회 최적화

3. **checklist_records(user_id, check_date)**: 복합 인덱스
   - 특정 사용자의 특정 날짜 기록 조회 최적화

4. **user_system_assignments.user_id**: INDEX
   - 사용자별 담당 시스템 조회 최적화

5. **user_system_assignments.system_id**: INDEX
   - 시스템별 담당자 조회 최적화

---

## 제약조건 (Constraints)

### CHECK 제약조건
- **checklist_records.status**: `status IN ('PASS', 'FAIL')`
  - 체크 상태는 반드시 'PASS' 또는 'FAIL'만 허용

### FOREIGN KEY 제약조건
- 모든 외래키는 `ON DELETE CASCADE`로 설정되어 있어, 부모 레코드가 삭제되면 자식 레코드도 자동 삭제됩니다.

### UNIQUE 제약조건
- **users.employee_id**: 사번은 고유해야 함
- **user_system_assignments(user_id, system_id)**: 같은 사용자-시스템 조합은 중복 불가 (애플리케이션 레벨)

---

## 데이터 흐름

### 1. 로그인 프로세스
```
사용자 입력 (employee_id, password)
  ↓
users 테이블에서 employee_id로 조회
  ↓
비밀번호 해시 검증
  ↓
JWT 토큰 생성 및 반환
```

### 2. 대시보드 조회 프로세스
```
사용자 로그인
  ↓
user_system_assignments에서 user_id로 조회
  ↓
담당 시스템 목록 반환
```

### 3. 체크리스트 작성 프로세스
```
시스템 선택
  ↓
check_items에서 system_id로 조회
  ↓
special_notes에서 각 항목의 특이사항 조회
  ↓
checklist_records에서 오늘 날짜 기록 조회 (기존 데이터 불러오기)
  ↓
사용자가 체크 및 저장
  ↓
checklist_records에 INSERT 또는 UPDATE
```

### 4. 스케줄러 알림 프로세스
```
매일 09:00, 12:00 실행
  ↓
모든 사용자 조회
  ↓
각 사용자의 담당 시스템 조회 (user_system_assignments)
  ↓
각 시스템의 모든 체크 항목 조회 (check_items)
  ↓
오늘 날짜의 체크 기록 조회 (checklist_records)
  ↓
미체크 항목 식별
  ↓
이메일 알림 발송 (users.email 사용)
```

---

## API 스키마 (Pydantic Models)

### 요청 스키마

#### UserLogin
```python
{
  "employee_id": "string",  # 사번
  "password": "string"      # 비밀번호
}
```

#### ChecklistSubmit
```python
{
  "items": [
    {
      "check_item_id": int,      # 체크 항목 ID
      "status": "PASS" | "FAIL",  # 체크 상태
      "notes": "string" | null    # 메모 (선택사항)
    }
  ]
}
```

### 응답 스키마

#### UserResponse
```python
{
  "id": int,
  "employee_id": "string",
  "name": "string",
  "email": "string"
}
```

#### SystemResponse
```python
{
  "id": int,
  "system_name": "string",
  "description": "string" | null
}
```

#### CheckItemResponse
```python
{
  "id": int,
  "system_id": int,
  "item_name": "string",
  "description": "string" | null,
  "order_index": int,
  "special_notes": ["string"]  # 특이사항 목록
}
```

#### ChecklistRecordResponse
```python
{
  "id": int,
  "user_id": int,
  "check_item_id": int,
  "check_date": "YYYY-MM-DD",
  "status": "PASS" | "FAIL",
  "notes": "string" | null,
  "checked_at": "YYYY-MM-DDTHH:MM:SS"
}
```

---

## 데이터 무결성 규칙

1. **사용자 삭제 시**: 해당 사용자의 모든 시스템 할당과 체크리스트 기록이 자동 삭제됩니다 (CASCADE DELETE).

2. **시스템 삭제 시**: 해당 시스템의 모든 체크 항목, 특이사항, 사용자 할당이 자동 삭제됩니다 (CASCADE DELETE).

3. **체크 항목 삭제 시**: 해당 항목의 모든 체크리스트 기록과 특이사항이 자동 삭제됩니다 (CASCADE DELETE).

4. **체크 상태**: 반드시 'PASS' 또는 'FAIL'만 허용됩니다.

5. **사번 중복**: 동일한 사번을 가진 사용자는 존재할 수 없습니다.

---

## 주의사항

1. **비밀번호 보안**: 비밀번호는 절대 평문으로 저장되지 않으며, bcrypt로 해시되어 저장됩니다.

2. **날짜 처리**: 체크리스트 기록은 날짜 단위로 관리되며, 같은 날짜에 같은 항목을 여러 번 체크할 수 없습니다.

3. **스케줄러**: 매일 09:00, 12:00에 미체크 항목을 확인하고 이메일 알림을 발송합니다.

4. **데이터 백업**: 정기적으로 `qa_checklist.db` 파일을 백업하는 것을 권장합니다.

5. **트랜잭션**: 체크리스트 저장 시 모든 항목이 성공적으로 저장되어야 하며, 일부만 저장되는 것을 방지하기 위해 트랜잭션을 사용합니다.

---

## 마이그레이션 및 스키마 변경

현재는 SQLAlchemy ORM을 사용하여 자동으로 테이블을 생성합니다 (`Base.metadata.create_all()`).

스키마를 변경할 경우:
1. `backend/models.py`에서 모델 수정
2. 애플리케이션 재시작 시 자동으로 테이블이 생성/업데이트됨
3. **주의**: SQLite는 ALTER TABLE 제약이 제한적이므로, 주요 스키마 변경 시 마이그레이션 스크립트 작성 권장

---

## 참고 파일

- **모델 정의**: `backend/models.py`
- **API 스키마**: `backend/schemas.py`
- **데이터베이스 연결**: `backend/database.py`
- **SQL 스키마**: `database/schema.sql` (참고용)

